# Development override with hot reload
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Features:
# - Web: Next.js dev server with fast refresh
# - API: tsx watch for instant TypeScript reload
# - Source files mounted as volumes (changes reflect instantly)

services:
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    volumes:
      # Mount source for hot reload
      - ./apps/web/src:/app/apps/web/src
      - ./apps/web/public:/app/apps/web/public
      - ./apps/web/tailwind.config.ts:/app/apps/web/tailwind.config.ts
      - ./apps/web/messages:/app/apps/web/messages
      - ./packages/shared/src:/app/packages/shared/src
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.dev
    volumes:
      # Mount source for hot reload
      - ./apps/api/src:/app/apps/api/src
      - ./apps/api/prisma:/app/apps/api/prisma
      - ./packages/shared/src:/app/packages/shared/src
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
    command: >
      sh -c "npx prisma migrate deploy && node --import tsx/esm --watch src/server.ts"
